#!/usr/bin/env bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Vibe Palace - Orbit Controller (vibe command)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Main CLI for the Vibe Solar System
# Orchestrates planet installation, dependency resolution, and health checks
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

set -euo pipefail

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SCRIPT CONFIGURATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source core libraries
source "$SCRIPT_DIR/lib/core.sh"
source "$SCRIPT_DIR/lib/state.sh"
source "$SCRIPT_DIR/lib/deps.sh"
source "$SCRIPT_DIR/lib/backup.sh"

# Explicitly set planets directory
export PLANETS_DIR="$SCRIPT_DIR/planets"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# GLOBAL VARIABLES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Command-line flags
DRY_RUN=0
VERBOSE=0
QUIET=0
YES=0

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# UTILITY FUNCTIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# show_banner: Display the Vibe Palace banner
show_banner() {
    cat <<'EOF'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                              â•‘
â•‘   â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â•‘
â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â•šâ•â•â–ˆâ–ˆâ•”â•â•â•     â–ˆâ–ˆâ•”â•â•â•â•â• â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•‘
â•‘   â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘        â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•‘
â•‘   â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘        â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•‘
â•‘   â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•‘
â•‘   â•šâ•â•  â•šâ•â•â•â•   â•šâ•â•â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•‘
â•‘                                                                              â•‘
â•‘                    Solar System Development Environment                      â•‘
â•‘                                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
}

# show_version: Display version information
show_version() {
    echo "Vibe Palace Orbit Controller v1.0.0"
    echo "Solar System Architecture"
    echo ""
}

# show_help: Display usage information
show_help() {
    show_version
    cat <<'EOF'
USAGE:
    vibe [OPTIONS] <COMMAND> [ARGS]

COMMANDS:
    install <planet>    Install a planet (and its dependencies)
    install --all       Install all available planets
    uninstall <planet>  Uninstall a planet
    status              Show installation status
    doctor              Run health checks on all installed planets
    list                List all available planets
    tree <planet>       Show dependency tree for a planet
    graph               Show dependency graph for all planets
    backup              Create a backup (configs + state)
    backup --configs    Backup only configuration files
    backup --list       List all available backups
    restore <file>      Restore from a backup file
    help                Show this help message

OPTIONS:
    --dry-run, -n       Show what would be done without doing it
    --verbose, -v       Show detailed output
    --quiet, -q         Suppress non-error output
    --yes, -y           Auto-confirm all prompts

EXAMPLES:
    vibe install mercury              # Install terminal tools
    vibe install venus                # Install editors (mercury auto-installs)
    vibe install --all                # Install everything
    vibe status                       # See what's installed
    vibe doctor                       # Check system health
    vibe uninstall jupiter            # Remove database tools
    vibe tree saturn                  # Show Saturn's dependencies
    vibe backup                       # Create full backup
    vibe backup --configs             # Backup configs only
    vibe restore vibe-backup-*.tar.gz # Restore from backup
    vibe backup --list                # List available backups

PLANETS:
    mercury    Terminal foundation (starship, eza, fzf, etc.)
    venus      Editors (Neovim, Helix)
    mars       Languages (Node.js, Python, Rust, Go)
    jupiter    Databases (PostgreSQL, MySQL, Redis, MongoDB)
    saturn     AI tools (Claude Code, aichat, MCP)
    uranus     Dev tools (Git, Docker, lazydocker)
    neptune    Containers (Docker, Kubernetes, Podman)
    pluto      Extras (Zsh, Atuin, tldr)

For more information, visit: https://github.com/your-username/vibe-palace
EOF
}

# log_verbose: Log message only in verbose mode
log_verbose() {
    if [[ $VERBOSE -eq 1 ]]; then
        log "$1"
    fi
}

# log_quiet: Log message only if not in quiet mode
log_quiet() {
    if [[ $QUIET -eq 0 ]]; then
        log "$1"
    fi
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PLANET INSTALLATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# cmd_install: Install a planet
cmd_install() {
    local target="$1"

    # Check if installing all planets
    if [[ "$target" == "--all" ]]; then
        cmd_install_all
        return $?
    fi

    # Validate planet exists
    if ! deps_planet_exists "$target"; then
        error "Planet not found: $target"
        log "Run 'vibe list' to see available planets"
        return 1
    fi

    log_quiet "ğŸš€ Calculating installation plan for: $target"

    # Calculate installation order
    local install_order
    install_order=$(deps_sort_topological "$target")

    if [[ -z "$install_order" ]]; then
        error "Failed to calculate installation order"
        return 1
    fi

    # Count planets to install
    local count=0
    while IFS= read -r planet; do
        [[ -n "$planet" ]] && ((count++))
    done <<< "$install_order"

    log_quiet ""
    log_quiet "Installation plan ($count planet(s)):"
    while IFS= read -r planet; do
        if [[ -n "$planet" ]]; then
            if state_is_installed "$planet"; then
                log_quiet "  â€¢ $planet (already installed)"
            else
                log_quiet "  â€¢ $planet (new)"
            fi
        fi
    done <<< "$install_order"

    # Dry run check
    if [[ $DRY_RUN -eq 1 ]]; then
        warn "Dry run mode - nothing will be installed"
        return 0
    fi

    # Confirmation prompt
    if [[ $YES -eq 0 ]]; then
        if ! ask_yes_no "Continue with installation?"; then
            log "Installation cancelled"
            return 0
        fi
    fi

    # Install each planet in order
    local installed=0
    local skipped=0
    local failed=0

    while IFS= read -r planet; do
        if [[ -z "$planet" ]]; then
            continue
        fi

        # Check if already installed
        if state_is_installed "$planet"; then
            log_verbose "$planet already installed, skipping..."
            ((skipped++))
            continue
        fi

        # Source and run planet install
        local planet_script="$PLANETS_DIR/$planet.sh"

        if [[ ! -f "$planet_script" ]]; then
            error "Planet script not found: $planet_script"
            ((failed++))
            continue
        fi

        log_quiet ""
        log_quiet "â”â”â” Installing: $planet â”â”â”"

        # Source the planet script
        if source "$planet_script"; then
            # Run install function
            if planet_install 2>&1; then
                success "$planet installed successfully"
                ((installed++))
            else
                error "$planet installation failed"
                ((failed++))
                log "You may need to clean up partial installation"
            fi
        else
            error "Failed to source planet: $planet"
            ((failed++))
        fi
    done <<< "$install_order"

    # Summary
    log_quiet ""
    banner "Installation Summary"
    log "Installed: $installed"
    log "Skipped: $skipped"
    if [[ $failed -gt 0 ]]; then
        error "Failed: $failed"
        return 1
    fi

    success "Installation complete!"
    return 0
}

# cmd_install_all: Install all available planets
cmd_install_all() {
    log_quiet "ğŸš€ Installing all planets in the solar system"

    # Get all planets
    local all_planets
    all_planets=$(deps_list_all)

    if [[ -z "$all_planets" ]]; then
        error "No planets found in $PLANETS_DIR"
        return 1
    fi

    # Calculate install order for all planets
    local install_order
    install_order=$(deps_resolve_install_order $all_planets)

    if [[ -z "$install_order" ]]; then
        error "Failed to calculate installation order"
        return 1
    fi

    # Count planets
    local count
    count=$(echo "$install_order" | wc -l)

    log_quiet ""
    log_quiet "Will install $count planet(s)"

    # Dry run check
    if [[ $DRY_RUN -eq 1 ]]; then
        warn "Dry run mode - nothing will be installed"
        echo "$install_order"
        return 0
    fi

    # Confirmation prompt
    if [[ $YES -eq 0 ]]; then
        if ! ask_yes_no "Install all planets?"; then
            log "Installation cancelled"
            return 0
        fi
    fi

    # Install each planet
    local installed=0
    local skipped=0
    local failed=0

    while IFS= read -r planet; do
        if [[ -z "$planet" ]]; then
            continue
        fi

        if state_is_installed "$planet"; then
            log_verbose "$planet already installed, skipping..."
            ((skipped++))
            continue
        fi

        local planet_script="$PLANETS_DIR/$planet.sh"

        if [[ ! -f "$planet_script" ]]; then
            error "Planet script not found: $planet_script"
            ((failed++))
            continue
        fi

        log_quiet ""
        log_quiet "â”â”â” Installing: $planet â”â”â”"

        if source "$planet_script"; then
            if planet_install 2>&1; then
                success "$planet installed successfully"
                ((installed++))
            else
                error "$planet installation failed"
                ((failed++))
            fi
        else
            error "Failed to source planet: $planet"
            ((failed++))
        fi
    done <<< "$install_order"

    # Summary
    log_quiet ""
    banner "Installation Summary"
    log "Installed: $installed"
    log "Skipped: $skipped"
    if [[ $failed -gt 0 ]]; then
        error "Failed: $failed"
        return 1
    fi

    success "Solar system installation complete!"
    return 0
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PLANET UNINSTALLATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# cmd_uninstall: Uninstall a planet
cmd_uninstall() {
    local planet="$1"

    # Validate planet exists
    if ! deps_planet_exists "$planet"; then
        error "Planet not found: $planet"
        return 1
    fi

    # Check if installed
    if ! state_is_installed "$planet"; then
        warn "$planet is not installed"
        return 0
    fi

    # Check for dependent planets
    local dependents=()
    while IFS= read -r p; do
        if [[ -n "$p" ]] && state_is_installed "$p"; then
            local deps
            deps=$(deps_get "$p" 2>/dev/null || echo "")
            if echo "$deps" | grep -q "^${planet}$"; then
                dependents+=("$p")
            fi
        fi
    done < <(deps_list_all)

    if [[ ${#dependents[@]} -gt 0 ]]; then
        warn "The following installed planet(s) depend on $planet:"
        for dep in "${dependents[@]}"; do
            warn "  â€¢ $dep"
        done
        warn "You should uninstall them first"
        if [[ $YES -eq 0 ]]; then
            if ! ask_yes_no "Continue anyway?"; then
                log "Uninstall cancelled"
                return 0
            fi
        fi
    fi

    # Dry run check
    if [[ $DRY_RUN -eq 1 ]]; then
        warn "Dry run mode - $planet would be uninstalled"
        return 0
    fi

    # Confirmation prompt
    if [[ $YES -eq 0 ]]; then
        if ! confirm_dangerous_operation "uninstall planet $planet"; then
            log "Uninstall cancelled"
            return 0
        fi
    fi

    # Source and run planet uninstall
    local planet_script="$PLANETS_DIR/$planet.sh"

    if source "$planet_script"; then
        if planet_uninstall 2>&1; then
            success "$planet uninstalled successfully"
            return 0
        else
            error "$planet uninstall failed"
            return 1
        fi
    else
        error "Failed to source planet: $planet"
        return 1
    fi
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STATUS & HEALTH CHECKS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# cmd_status: Show installation status
cmd_status() {
    banner "ğŸª Vibe Palace Status"

    local installed_count
    installed_count=$(state_count)

    echo ""
    info "Installed planets: $installed_count"
    echo ""

    # Show installed planets
    local installed_planets
    installed_planets=$(state_list)

    if [[ -z "$installed_planets" ]]; then
        warn "No planets installed yet"
        echo ""
        log "Install a planet with: vibe install <planet>"
        return 0
    fi

    while IFS= read -r planet; do
        if [[ -n "$planet" ]]; then
            local version
            version=$(state_get_version "$planet")
            echo "  â€¢ $planet (v$version)"
        fi
    done <<< "$installed_planets"

    echo ""
    log "Last update: $(state_last_update)"
}

# cmd_doctor: Run health checks on all installed planets
cmd_doctor() {
    banner "ğŸ¥ Vibe Palace Health Check"

    local installed_planets
    installed_planets=$(state_list)

    if [[ -z "$installed_planets" ]]; then
        warn "No planets installed"
        return 0
    fi

    local total_failed=0

    while IFS= read -r planet; do
        if [[ -z "$planet" ]]; then
            continue
        fi

        echo ""
        step "Checking $planet..."

        local planet_script="$PLANETS_DIR/$planet.sh"

        if [[ ! -f "$planet_script" ]]; then
            error "Planet script not found: $planet"
            ((total_failed++))
            continue
        fi

        if source "$planet_script"; then
            if ! planet_check_health 2>&1; then
                ((total_failed++))
            fi
        else
            error "Failed to source planet: $planet"
            ((total_failed++))
        fi
    done <<< "$installed_planets"

    echo ""
    if [[ $total_failed -eq 0 ]]; then
        success "All systems operational!"
        return 0
    else
        error "Health check failed: $total_failed planet(s) have issues"
        return 1
    fi
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# INFORMATION COMMANDS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# cmd_list: List all available planets
cmd_list() {
    banner "ğŸª Available Planets"

    echo ""

    while IFS= read -r planet; do
        if [[ -z "$planet" ]]; then
            continue
        fi

        local planet_script="$PLANETS_DIR/$planet.sh"

        # Get metadata
        local metadata=""
        if source "$planet_script" 2>/dev/null; then
            metadata=$(planet_metadata 2>/dev/null || echo "{}")
        fi

        local desc=""
        local version="unknown"

        if command_exists jq; then
            desc=$(echo "$metadata" | jq -r '.description // ""' 2>/dev/null || echo "")
            version=$(echo "$metadata" | jq -r '.version // "unknown"' 2>/dev/null || echo "unknown")
        fi

        local status="${GREEN}âœ“${NC} installed"
        if ! state_is_installed "$planet"; then
            status="${YELLOW}â—‹${NC} not installed"
        fi

        printf "  ${BOLD}%s${NC} (%s) [%s]\n" "$planet" "$version" "$status"
        if [[ -n "$desc" ]]; then
            printf "    %s\n" "$desc"
        fi
        echo ""
    done < <(deps_list_all)
}

# cmd_tree: Show dependency tree for a planet
cmd_tree() {
    local planet="$1"

    if ! deps_planet_exists "$planet"; then
        error "Planet not found: $planet"
        return 1
    fi

    banner "ğŸŒ³ Dependency Tree: $planet"
    echo ""

    deps_show_tree "$planet"
}

# cmd_graph: Show dependency graph
cmd_graph() {
    banner "ğŸ•¸ï¸  Dependency Graph"
    echo ""

    deps_show_graph
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# BACKUP & RESTORE COMMANDS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# cmd_backup: Create backup
cmd_backup() {
    local option="${1:-}"

    case "$option" in
        --configs)
            banner "ğŸ’¾ Config Backup"
            echo ""

            log "Creating configuration-only backup..."
            local backup_file
            backup_file=$(backup_configs_only)

            if [[ -n "$backup_file" ]]; then
                success "Config backup complete!"
                log "Backup saved to: $backup_file"
            else
                return 1
            fi
            ;;
        --list)
            backup_list
            ;;
        "")
            banner "ğŸ’¾ Full Backup"
            echo ""

            log "Creating full backup (configs + state)..."
            local backup_file
            backup_file=$(backup_create)

            if [[ -n "$backup_file" ]]; then
                success "Backup complete!"
                log "Backup saved to: $backup_file"
            else
                return 1
            fi
            ;;
        *)
            error "Unknown backup option: $option"
            echo "Usage: vibe backup [--configs|--list]"
            return 1
            ;;
    esac
}

# cmd_restore: Restore from backup
cmd_restore() {
    local backup_file="$1"

    if [[ -z "$backup_file" ]]; then
        error "Missing backup file"
        echo "Usage: vibe restore <backup-file.tar.gz>"
        echo "Run 'vibe backup --list' to see available backups"
        return 1
    fi

    # Expand glob if needed
    if [[ "$backup_file" == *"*" ]]; then
        local expanded
        expanded=$(ls $backup_file 2>/dev/null | head -n 1)

        if [[ -z "$expanded" ]]; then
            error "No backup files found matching: $backup_file"
            return 1
        fi

        backup_file="$expanded"
    fi

    if [[ ! -f "$backup_file" ]]; then
        error "Backup file not found: $backup_file"
        return 1
    fi

    # Confirmation prompt
    if [[ $YES -eq 0 ]]; then
        warn "This will overwrite existing configuration files!"
        if ! confirm_dangerous_operation "restore from $backup_file"; then
            log "Restore cancelled"
            return 0
        fi
    fi

    banner "ğŸ“¥ Restore from Backup"
    echo ""

    if backup_restore "$backup_file"; then
        success "Restore complete!"
        return 0
    else
        error "Restore failed"
        return 1
    fi
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ARGUMENT PARSING
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Parse command-line arguments
parse_args() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --dry-run|-n)
                DRY_RUN=1
                shift
                ;;
            --verbose|-v)
                VERBOSE=1
                shift
                ;;
            --quiet|-q)
                QUIET=1
                shift
                ;;
            --yes|-y)
                YES=1
                shift
                ;;
            -*)
                error "Unknown option: $1"
                echo "Run 'vibe help' for usage"
                exit 1
                ;;
            *)
                break
                ;;
        esac
    done

    # Return remaining arguments
    echo "$@"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MAIN ENTRY POINT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

main() {
    # Parse arguments
    local remaining
    remaining=$(parse_args "$@")

    # Rebuild arguments array
    eval "set -- $remaining"

    # Initialize state
    state_init

    # Show banner unless in quiet mode
    if [[ $QUIET -eq 0 ]]; then
        show_banner
        echo ""
    fi

    # Handle commands
    if [[ $# -eq 0 ]]; then
        show_help
        exit 0
    fi

    local command="$1"
    shift

    case "$command" in
        install)
            if [[ $# -eq 0 ]]; then
                error "Missing planet name"
                echo "Usage: vibe install <planet|--all>"
                exit 1
            fi
            cmd_install "$1"
            ;;
        uninstall)
            if [[ $# -eq 0 ]]; then
                error "Missing planet name"
                echo "Usage: vibe uninstall <planet>"
                exit 1
            fi
            cmd_uninstall "$1"
            ;;
        status)
            cmd_status
            ;;
        doctor)
            cmd_doctor
            ;;
        list)
            cmd_list
            ;;
        tree)
            if [[ $# -eq 0 ]]; then
                error "Missing planet name"
                echo "Usage: vibe tree <planet>"
                exit 1
            fi
            cmd_tree "$1"
            ;;
        graph)
            cmd_graph
            ;;
        backup)
            cmd_backup "${1:-}"
            ;;
        restore)
            if [[ $# -eq 0 ]]; then
                error "Missing backup file"
                echo "Usage: vibe restore <backup-file.tar.gz>"
                exit 1
            fi
            cmd_restore "$1"
            ;;
        help|--help|-h)
            show_help
            ;;
        version|--version|-V)
            show_version
            ;;
        *)
            error "Unknown command: $command"
            echo ""
            echo "Run 'vibe help' for usage"
            exit 1
            ;;
    esac
}

# Run main function
main "$@"
